<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2TrancePrivate</title>
    
    <link rel="manifest" href="/manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ログイン画面のスタイル */
        .login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .login-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 3rem;
            max-width: 400px;
            width: 100%;
        }
        
        .login-card h2 {
            font-size: 2rem;
            font-weight: 300;
            color: #111827;
            margin-bottom: 1rem;
            letter-spacing: -0.025em;
        }
        
        .login-card p {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 300;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .google-signin-btn:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        /* メインコンテンツ（チャット風） */
        .main-content {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100vh;
        }
        
        /* ヘッダー */
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 300;
            color: #111827;
        }
        
        .status {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status.disconnected {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .status.connecting {
            background: #fffbeb;
            color: #d97706;
        }
        
        .status.connected {
            background: #dcfce7;
            color: #166534;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
        }
        
        .logout-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* メッセージエリア（メイン） */
        .message-area {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .message {
            max-width: 70%;
            margin: 1rem 0;
            padding: 1rem 1.5rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            white-space: pre-wrap;
        }
        
        .message.sent {
            background: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.5rem;
        }
        
        .message.received {
            background: white;
            color: #374151;
            margin-right: auto;
            border-bottom-left-radius: 0.5rem;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }
        
        /* コピーボタン */
        .copy-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-top: 0.5rem;
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 0.25rem;
            cursor: pointer;
            color: inherit;
        }
        
        /* ファイルメッセージ */
        .file-message {
            max-width: 18rem;
        }
        
        .file-info-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 0.375rem 0;
        }
        
        .file-download {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }
        
        .image-preview {
            max-width: 100%;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        .save-btn {
            margin-top: 0.5rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        /* 入力エリア（下部固定） */
        .input-area {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .file-preview-area {
            flex: 1;
            min-height: 3rem;
            border: 2px dashed #d1d5db;
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .file-preview-area.has-content {
            border-color: #3b82f6;
            background: #eff6ff;
            border-style: solid;
        }
        
        .file-preview-area.dragover {
            border-color: #3b82f6;
            background: #dbeafe;
            transform: scale(1.02);
        }
        
        .message-input {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-size: 1rem;
            resize: none;
            min-height: 2rem;
            max-height: 6rem;
            font-family: inherit;
        }
        
        .message-input::placeholder {
            color: #9ca3af;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            width: 3rem;
            height: 3rem;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .file-btn {
            background: #10b981;
            color: white;
        }
        
        .paste-btn {
            background: #0ea5e9;
            color: white;
        }
        
        .send-btn {
            background: #3b82f6;
            color: white;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .action-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ファイルプレビュー */
        .file-preview {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        
        .file-icon {
            width: 2rem;
            height: 2rem;
            background: #3b82f6;
            color: white;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .preview-img {
            max-width: 3rem;
            max-height: 3rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            color: #374151;
        }
        
        .file-size {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .remove-file {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        /* 画像オーバーレイ */
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }
        
        /* レスポンシブ */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
            
            .input-area {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .action-buttons {
                align-self: stretch;
                justify-content: space-around;
            }
            
            .action-btn {
                flex: 1;
                border-radius: 0.75rem;
                max-width: none;
                height: 2.5rem;
            }
            
            .message {
                max-width: 85%;
                padding: 0.75rem 1rem;
            }
        }
        
        #fileInput {
            display: none;
        }
        
        /* ローディング */
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6b7280;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="login-section" id="loginSection">
        <div class="login-card">
            <h2>P2TrancePrivate</h2>
            <p>Googleアカウントでログインして、安全なP2P通信を開始してください</p>
            <button class="google-signin-btn" onclick="handleSignIn()">
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                    <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 0 1-7.18-2.53H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                    <path fill="#FBBC05" d="M4.5 10.49a4.8 4.8 0 0 1 0-3.07V5.35H1.83a8 8 0 0 0 0 7.28l2.67-2.14z"/>
                    <path fill="#EA4335" d="M8.98 4.72c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.35L4.5 7.42a4.77 4.77 0 0 1 4.48-2.7z"/>
                </svg>
                Googleでログイン
            </button>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="header">
            <h1>P2TrancePrivate</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="status disconnected" id="status">
                    デバイス検索中...
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="" alt="ユーザーアバター">
                    <span id="userName" style="font-size: 0.875rem;"></span>
                    <button class="logout-btn" onclick="handleSignOut()">ログアウト</button>
                </div>
            </div>
        </div>
        
        <div class="message-area" id="messageHistory">
        </div>
        
        <div class="input-area">
            <div class="file-preview-area" id="dropZone">
                <textarea class="message-input" id="messageInput" placeholder="メッセージを入力してください..." disabled></textarea>
                <div class="file-preview" id="filePreview" style="display: none;">
                    <img id="previewImg" class="preview-img" style="display: none;">
                    <div id="fileIcon" class="file-icon" style="display: none;">FILE</div>
                    <div class="file-info">
                        <div class="file-name" id="fileName"></div>
                        <div class="file-size" id="fileSize"></div>
                    </div>
                    <button class="remove-file" onclick="clearPreview()">×</button>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn file-btn" onclick="selectFile()" disabled id="fileBtn">FILE</button>
                <button class="action-btn paste-btn" onclick="pasteText()" disabled id="pasteBtn">PASTE</button>
                <button class="action-btn send-btn" id="sendBtn" onclick="sendMessage()" disabled>送信</button>
            </div>
        </div>
    </div>
    
    <div class="image-overlay" id="imageOverlay" onclick="closeImageOverlay()">
        <img id="overlayImg">
    </div>
    
    <input type="file" id="fileInput" onchange="handleFileSelect(event)">

    <script type="module">
        import { getFirebaseConfig } from './firebase-config.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getDatabase, ref, set, onValue, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

        // Firebaseの初期化
        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app); 
        
        // Google認証プロバイダーの設定
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        // グローバルオブジェクトにFirebase認証ヘルパーをアタッチ
        window.firebaseAuth = {
            signIn: async () => {
                try {
                    const result = await signInWithPopup(auth, provider);
                    return result;
                } catch (error) {
                    console.warn('ポップアップログインに失敗、リダイレクト方式を試行:', error);
                    const { signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js');
                    return signInWithRedirect(auth, provider);
                }
            },
            signOut: () => signOut(auth),
            onAuthStateChanged: (callback) => onAuthStateChanged(auth, callback),
            db: {
                getDeviceRef: (userId, peerId) => ref(db, `usersOnline/${userId}/${peerId}`),
                getDevicesRef: (userId) => ref(db, `usersOnline/${userId}`),
                set,
                remove,
                onValue,
                onDisconnect
            }
        };
        
        // PWA: サービスワーカーの登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    
    <script>
        // グローバル変数の定義
        let currentUser = null;
        let peer = null;
        let connections = new Map();
        let selectedFile = null;
        let onlineUsers = new Set();
        let peerWatcher = null; 
        
        // DOM要素の取得
        const statusEl = document.getElementById('status');
        const sendBtn = document.getElementById('sendBtn');
        const fileBtn = document.getElementById('fileBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const messageInput = document.getElementById('messageInput');
        const messageHistory = document.getElementById('messageHistory');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const previewImg = document.getElementById('previewImg');
        const fileIcon = document.getElementById('fileIcon');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const imageOverlay = document.getElementById('imageOverlay');
        const overlayImg = document.getElementById('overlayImg');
        const loginSection = document.getElementById('loginSection');
        const mainContent = document.getElementById('mainContent');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');

        window.handleSignIn = async function() {
            if (!window.firebaseAuth) {
                alert('Firebase認証モジュールがまだ読み込まれていません。しばらく待ってから再度お試しください。');
                return;
            }
            try {
                const result = await window.firebaseAuth.signIn();
                console.log('ログイン成功:', result.user);
            } catch (error) {
                console.error('ログインエラー:', error);
                alert('ログインに失敗しました: ' + error.message);
            }
        };

        window.handleSignOut = async function() {
            if (!window.firebaseAuth) {
                console.error('Firebase認証モジュールが未定義です。');
                return;
            }
            if (peer && currentUser) {
                const db = window.firebaseAuth.db;
                const devicesRef = db.getDevicesRef(currentUser.id);
                const deviceRef = db.getDeviceRef(currentUser.id, peer.id);
                
                if (peerWatcher) {
                    db.onValue(devicesRef, peerWatcher); 
                    peerWatcher = null;
                }
                
                await db.remove(deviceRef);
            }
            
            try {
                await window.firebaseAuth.signOut();
                console.log('ログアウト成功');
            } catch (error) {
                console.error('ログアウトエラー:', error);
                alert('ログアウトに失敗しました: ' + error.message);
            }
        };

        function updateUI(user) {
            if (user) {
                loginSection.style.display = 'none';
                mainContent.style.display = 'flex';
                userInfo.style.display = 'flex';

                userName.textContent = user.name;
                userAvatar.src = user.picture;

                initializeP2P();
            } else {
                loginSection.style.display = 'flex';
                mainContent.style.display = 'none';
                userInfo.style.display = 'none';

                if (peer) {
                    peer.destroy();
                    peer = null;
                }
                connections.clear();
                onlineUsers.clear();
                clearMessageHistory();
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            let attempts = 0;
            const maxAttempts = 50; 
            
            while (!window.firebaseAuth && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (window.firebaseAuth) {
                window.firebaseAuth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = {
                            id: user.uid,
                            name: user.displayName,
                            email: user.email,
                            picture: user.photoURL
                        };
                    } else {
                        currentUser = null;
                    }
                    updateUI(currentUser);
                });
            } else {
                console.error("Firebase認証モジュールの読み込みに失敗しました。");
                updateStatus('致命的なエラー: 認証機能が利用できません', 'disconnected');
            }
        });

        async function initializeP2P() {
            updateStatus('P2P接続を初期化中...', 'connecting');
            
            const peerOptions = {
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            };
            
            const deviceSuffix = Math.random().toString(36).substring(2, 8);
            const peerId = 'user-' + currentUser.id.substring(0, 12) + '-' + deviceSuffix;
            peer = new Peer(peerId, peerOptions);
            
            peer.on('open', async (id) => {
                console.log('My peer ID is: ' + id);
                
                const db = window.firebaseAuth.db;
                const deviceRef = db.getDeviceRef(currentUser.id, id);
                
                await db.set(deviceRef, {
                    peerId: id,
                    name: navigator.userAgent.substring(0, 30), 
                    timestamp: Date.now()
                });
                db.onDisconnect(deviceRef).remove();

                updateStatus('他のデバイスを検索中...', 'connecting');
                
                startPeerDiscovery(id);
                
                messageInput.disabled = false;
                fileBtn.disabled = false;
                pasteBtn.disabled = false;
            });
            
            peer.on('connection', (conn) => {
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                updateStatus('エラーが発生しました: ' + err.message, 'disconnected');
            });
        }
        
        function startPeerDiscovery(myPeerId) {
            const db = window.firebaseAuth.db;
            const devicesRef = db.getDevicesRef(currentUser.id);
            
            peerWatcher = db.onValue(devicesRef, (snapshot) => {
                const devices = snapshot.val();
                if (!devices) return;

                Object.keys(devices).forEach(peerId => {
                    if (peerId !== myPeerId && !connections.has(peerId)) {
                        tryConnectToUser(peerId);
                    }
                });
            });
        }
        
        function tryConnectToUser(userId) {
            try {
                const conn = peer.connect(userId, { reliable: true });
                setupConnection(conn);
            } catch (err) {
                console.log('Failed to connect to user:', userId);
            }
        }

        function setupConnection(conn) {
            conn.on('open', () => {
                connections.set(conn.peer, conn);
                onlineUsers.add(conn.peer);
                
                updateConnectionStatus();
                
                conn.send({
                    type: 'user_info',
                    user: currentUser,
                    timestamp: new Date().toISOString()
                });
            });
            
            conn.on('data', (data) => {
                console.log('Received:', data);
                handleReceivedData(data, conn.peer);
            });
            
            conn.on('close', () => {
                connections.delete(conn.peer);
                onlineUsers.delete(conn.peer);
                updateConnectionStatus();
            });
            
            conn.on('error', (err) => {
                console.error('Connection error:', err);
                connections.delete(conn.peer);
                onlineUsers.delete(conn.peer);
                updateConnectionStatus();
            });
        }

        function updateConnectionStatus() {
            const connectedCount = connections.size;
            if (connectedCount > 0) {
                updateStatus(`${connectedCount}人のデバイスと接続済み`, 'connected');
                sendBtn.disabled = false;
            } else {
                updateStatus('他のデバイスを検索中...', 'connecting');
                sendBtn.disabled = true;
            }
        }
        
        function handleReceivedData(data, fromPeer) {
            const timestamp = new Date().toLocaleTimeString();
            
            if (data.type === 'user_info') {
                console.log('User info received from:', fromPeer, data.user);
                return;
            }
            
            if (data.type === 'text') {
                addMessage(data.message, 'received', data.timestamp || timestamp, fromPeer);
            } else if (data.type === 'image') {
                addImageMessage(data.fileData, data.filename, data.filesize, 'received', data.timestamp || timestamp, data.message, fromPeer);
            } else if (data.type === 'file') {
                addFileMessage(data.fileData, data.filename, data.filesize, data.filetype, 'received', data.timestamp || timestamp, data.message, fromPeer);
            }
        }
        
        function broadcastToAllConnections(data) {
            connections.forEach((conn, peerId) => {
                if (conn.open) {
                    conn.send(data);
                }
            });
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            const timestamp = new Date().toLocaleTimeString();
            
            if (connections.size === 0) return;
            
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = e.target.result;
                    const isImage = selectedFile.type.startsWith('image/');
                    
                    const data = {
                        type: isImage ? 'image' : 'file',
                        fileData: fileData,
                        filename: selectedFile.name,
                        filesize: formatFileSize(selectedFile.size),
                        filetype: selectedFile.type,
                        timestamp: timestamp
                    };
                    
                    if (message) {
                        data.message = message;
                    }
                    
                    broadcastToAllConnections(data);
                    
                    if (isImage) {
                        addImageMessage(fileData, selectedFile.name, formatFileSize(selectedFile.size), 'sent', timestamp, message);
                    } else {
                        addFileMessage(fileData, selectedFile.name, formatFileSize(selectedFile.size), selectedFile.type, 'sent', timestamp, message);
                    }
                    
                    clearPreview();
                    messageInput.value = '';
                };
                reader.readAsDataURL(selectedFile);
            }
            else if (message) {
                const data = {
                    type: 'text',
                    message: message,
                    timestamp: timestamp
                };
                
                broadcastToAllConnections(data);
                addMessage(message, 'sent', timestamp);
                messageInput.value = '';
            }
        }
        
        function updateStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addMessage(message, type, timestamp, fromPeer = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const messageText = document.createElement('div');
            messageText.textContent = message;
            
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'コピー';
            copyBtn.className = 'copy-btn';
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(message).then(() => {
                    copyBtn.textContent = 'コピー済み!';
                    setTimeout(() => copyBtn.textContent = 'コピー', 1500);
                }).catch(() => {
                    copyBtn.textContent = '失敗';
                    setTimeout(() => copyBtn.textContent = 'コピー', 1500);
                });
            };
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = fromPeer ? `${timestamp} - ${fromPeer}` : timestamp;
            
            messageEl.appendChild(messageText);
            messageEl.appendChild(copyBtn);
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addImageMessage(imageData, filename, filesize, type, timestamp, message = '', fromPeer = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type} image-message`;
            
            const imgEl = document.createElement('img');
            imgEl.src = imageData;
            imgEl.onclick = () => showImageOverlay(imageData);
            imgEl.className = 'image-preview';
            
            const fileInfoEl = document.createElement('div');
            fileInfoEl.className = 'file-info';
            fileInfoEl.textContent = `${filename} (${filesize})`;
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = fromPeer ? `${timestamp} - ${fromPeer}` : timestamp;
            
            messageEl.appendChild(imgEl);
            messageEl.appendChild(fileInfoEl);
            
            if (message) {
                const messageText = document.createElement('div');
                messageText.textContent = message;
                messageText.style.marginTop = '0.5rem';
                messageEl.appendChild(messageText);
            }

            const saveBtn = document.createElement('button');
            saveBtn.textContent = '保存';
            saveBtn.className = 'save-btn';
            saveBtn.onclick = () => downloadFile(imageData, filename);
            messageEl.appendChild(saveBtn);
            
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addFileMessage(fileData, filename, filesize, filetype, type, timestamp, message = '', fromPeer = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type} file-message`;
            
            const fileInfoEl = document.createElement('div');
            fileInfoEl.className = 'file-info-display';
            
            const fileIconEl = document.createElement('div');
            fileIconEl.className = 'file-icon';
            fileIconEl.style.fontSize = '0.75rem';
            fileIconEl.style.fontWeight = 'bold';
            fileIconEl.style.textAlign = 'center';
            fileIconEl.style.marginBottom = '0.75rem';
            fileIconEl.textContent = getFileIcon(filetype);
            
            const fileNameEl = document.createElement('div');
            fileNameEl.style.fontWeight = '600';
            fileNameEl.style.marginBottom = '0.375rem';
            fileNameEl.textContent = filename;
            
            const fileDetailsEl = document.createElement('div');
            fileDetailsEl.className = 'file-info';
            fileDetailsEl.innerHTML = `${getFileTypeName(filetype)} • ${filesize}`;
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'file-download';
            downloadBtn.textContent = 'ダウンロード';
            downloadBtn.onclick = () => downloadFile(fileData, filename);
            
            fileInfoEl.appendChild(fileIconEl);
            fileInfoEl.appendChild(fileNameEl);
            fileInfoEl.appendChild(fileDetailsEl);
            fileInfoEl.appendChild(downloadBtn);
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = fromPeer ? `${timestamp} - ${fromPeer}` : timestamp;
            
            messageEl.appendChild(fileInfoEl);
            
            if (message) {
                const messageText = document.createElement('div');
                messageText.textContent = message;
                messageText.style.marginTop = '0.75rem';
                messageText.style.padding = '0.75rem';
                messageText.style.background = 'rgba(255,255,255,0.5)';
                messageText.style.borderRadius = '0.5rem';
                messageEl.appendChild(messageText);
            }
            
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function clearMessageHistory() {
            messageHistory.innerHTML = '';
        }
        
        function selectFile() {
            fileInput.click();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                showFilePreview(file);
            }
        }
        
        function showFilePreview(file) {
            const isImage = file.type.startsWith('image/');
            
            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                    fileIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.style.display = 'none';
                fileIcon.style.display = 'flex';
                fileIcon.textContent = getFileIcon(file.type);
            }
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.style.display = 'flex';
            dropZone.classList.add('has-content');
        }
        
        function clearPreview() {
            selectedFile = null;
            filePreview.style.display = 'none';
            dropZone.classList.remove('has-content');
            fileInput.value = '';
        }
        
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'IMG';
            if (mimeType.startsWith('video/')) return 'VID';
            if (mimeType.includes('pdf')) return 'PDF';
            if (mimeType.includes('word')) return 'DOC';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'XLS';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'PPT';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('7z')) return 'ZIP';
            if (mimeType.includes('text')) return 'TXT';
            if (mimeType.includes('json') || mimeType.includes('xml')) return 'DATA';
            return 'FILE';
        }
        
        function getFileTypeName(mimeType) {
            const typeMap = {
                'application/pdf': 'PDFドキュメント',
                'application/msword': 'Wordドキュメント',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Wordドキュメント',
                'application/vnd.ms-excel': 'Excelスプレッドシート',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excelスプレッドシート',
                'application/vnd.ms-powerpoint': 'PowerPointプレゼンテーション',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'PowerPointプレゼンテーション',
                'application/zip': 'ZIPアーカイブ',
                'application/x-rar-compressed': 'RARアーカイブ',
                'text/plain': 'テキストファイル',
                'text/csv': 'CSVファイル',
                'application/json': 'JSONファイル',
                'text/xml': 'XMLファイル'
            };
            
            if (mimeType.startsWith('image/')) return '画像ファイル';
            if (mimeType.startsWith('video/')) return '動画ファイル';
            if (mimeType.startsWith('audio/')) return '音声ファイル';
            
            return typeMap[mimeType] || 'ファイル';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showImageOverlay(imageData) {
            overlayImg.src = imageData;
            imageOverlay.style.display = 'flex';
        }
        
        function closeImageOverlay() {
            imageOverlay.style.display = 'none';
        }
        
        function downloadFile(fileData, filename) {
            const link = document.createElement('a');
            link.href = fileData;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function pasteText() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    messageInput.value = text;
                    messageInput.focus();
                } else {
                    alert('クリップボードにテキストが見つかりません。');
                }
            } catch (err) {
                console.error('Clipboard access error:', err);
                alert('クリップボードにアクセスできませんでした。ブラウザの許可設定を確認してください。');
            }
        }
        
        // ドラッグ&ドロップ機能
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                selectedFile = file;
                showFilePreview(file);
            }
        });
        
        // Enterキーでメッセージ送信
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Ctrl+Vでテキスト貼り付け
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v' && connections.size > 0) {
                if (document.activeElement === messageInput) {
                    return;
                }
                e.preventDefault();
                pasteText();
            }
        });
        
        // ページ終了時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            connections.forEach(conn => conn.close());
            if (peer) {
                if (currentUser) {
                    const db = window.firebaseAuth.db;
                    const deviceRef = db.getDeviceRef(currentUser.id, peer.id);
                    db.remove(deviceRef);
                }
                peer.destroy();
            }
        });
    </script>
</body>
</html>
