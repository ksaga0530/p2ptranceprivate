<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2TrancePrivate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
            color: #111827;
        }
        
        /* Navigation */
        .nav {
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .nav-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .nav h1 {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: -0.025em;
            color: #111827;
        }
        
        .nav-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.875rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
        }
        
        .logout-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: #b91c1c;
        }
        
        .status-text {
            color: #6b7280;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        
        /* Login Section */
        .login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
        }
        
        .login-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .login-card h2 {
            font-size: 2rem;
            font-weight: 300;
            color: #111827;
            margin-bottom: 1rem;
            letter-spacing: -0.025em;
        }
        
        .login-card p {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 300;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .google-signin-btn:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        /* Main Content (hidden until logged in) */
        .main-content {
            display: none;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 4rem;
        }
        
        .header h2 {
            font-size: 3rem;
            font-weight: 200;
            color: #111827;
            margin-bottom: 1rem;
            letter-spacing: -0.025em;
        }
        
        .header p {
            font-size: 1.25rem;
            color: #6b7280;
            font-weight: 300;
            max-width: 32rem;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Status */
        .status {
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .status.disconnected {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .status.connecting {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }
        
        .status.connected {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            border-bottom: 1px solid #f3f4f6;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #111827;
            letter-spacing: -0.025em;
        }
        
        .card-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .card-content {
            padding: 2rem;
        }
        
        /* Form Elements */
        input, button, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #6b7280;
            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
        }
        
        button {
            background: #111827;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            margin-top: 0.75rem;
            transition: all 0.3s ease;
        }
        
        button:hover:not(:disabled) {
            background: #1f2937;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Message Section */
        .input-area {
            position: relative;
        }
        
        textarea {
            height: 6rem;
            resize: vertical;
            padding-right: 5rem;
        }
        
        .input-buttons {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .input-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            cursor: pointer;
            font-size: 0.625rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
        }
        
        .file-btn {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }
        
        .paste-btn {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
        
        .input-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            color: #6b7280;
            margin: 1rem 0;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .drop-zone.dragover {
            border-color: #6b7280;
            background: #f9fafb;
            color: #111827;
        }
        
        /* File Preview */
        .preview-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.625rem;
            font-weight: 700;
            color: #6b7280;
        }
        
        .image-preview {
            max-width: 9rem;
            max-height: 9rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        .file-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .clear-btn {
            margin-top: 0.5rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        /* Message History */
        .message-history {
            background: #f9fafb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            max-height: 18rem;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }
        
        .message {
            margin: 0.75rem 0;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .message.sent {
            background: #111827;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.received {
            background: #e0f2fe;
            color: #0277bd;
            margin-right: auto;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.375rem;
        }
        
        /* File Messages */
        .file-message {
            max-width: 18rem;
        }
        
        .file-info-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 0.375rem 0;
        }
        
        .file-download {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }
        
        .file-download:hover {
            background: #1d4ed8;
        }
        
        /* Image Overlay */
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }
        
        .image-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 0.75rem;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6b7280;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: 2rem 1rem;
            }
            
            .nav-content {
                padding: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .header h2 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .card-header, .card-content {
                padding: 1.5rem;
            }
            
            textarea {
                height: 5rem;
                font-size: 16px;
            }
            
            .input-buttons {
                right: 0.375rem;
                top: 0.375rem;
            }
            
            .input-btn {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.5rem;
            }
            
            input, button, textarea {
                font-size: 16px;
            }
        }
        
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <h1>P2TrancePrivate</h1>
            <div class="nav-status">
                <div class="user-info" id="userInfo" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="" alt="ユーザーアバター">
                    <span id="userName"></span>
                    <button class="logout-btn" onclick="handleSignOut()">ログアウト</button>
                </div>
                <span class="status-text">WebRTCによるセキュア通信</span>
                <div class="status-indicator"></div>
            </div>
        </div>
    </nav>

    <!-- Login Section -->
    <div class="login-section" id="loginSection">
        <div class="login-card">
            <h2>P2TrancePrivate</h2>
            <p>Googleアカウントでログインして、安全なP2P通信を開始してください</p>
            <button class="google-signin-btn" onclick="handleSignIn()">
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                    <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 0 1-7.18-2.53H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                    <path fill="#FBBC05" d="M4.5 10.49a4.8 4.8 0 0 1 0-3.07V5.35H1.83a8 8 0 0 0 0 7.28l2.67-2.14z"/>
                    <path fill="#EA4335" d="M8.98 4.72c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.35L4.5 7.42a4.77 4.77 0 0 1 4.48-2.7z"/>
                </svg>
                Googleでログイン
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container main-content" id="mainContent">
        <!-- Header Section -->
        <div class="header">
            <h2>セキュアP2Pファイル転送</h2>
            <p>ログイン済みユーザー間での暗号化通信によるファイル共有</p>
        </div>

        <!-- Status -->
        <div class="status disconnected" id="status">
            他のユーザーを検索中...
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Message & File Section -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">メッセージ & ファイル</h3>
                        <p class="card-subtitle">テキストメッセージと任意のファイル形式を送信</p>
                    </div>
                </div>
                <div class="card-content">
                    <div class="drop-zone" id="dropZone">
                        ファイルをここにドロップするか、下のボタンを使用してください
                    </div>
                    
                    <div class="input-area">
                        <textarea id="messageInput" placeholder="メッセージを入力..." disabled></textarea>
                        <div class="input-buttons">
                            <button class="input-btn file-btn" onclick="selectFile()" title="ファイル選択" disabled id="fileBtn">FILE</button>
                            <button class="input-btn paste-btn" onclick="pasteText()" title="テキスト貼り付け" disabled id="pasteBtn">PASTE</button>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" onchange="handleFileSelect(event)">
                    
                    <div id="filePreview" style="display: none;">
                        <div class="preview-container">
                            <div id="previewContainer">
                                <img id="previewImg" class="image-preview" style="display: none;">
                                <div id="fileIcon" class="file-icon" style="display: none;">FILE</div>
                            </div>
                            <div class="file-details">
                                <div id="fileName"></div>
                                <div id="fileSize" class="file-info"></div>
                                <div id="fileType" class="file-info"></div>
                                <button onclick="clearPreview()" class="clear-btn">削除</button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="sendMessage()" id="sendBtn" disabled>送信</button>
                    
                    <div class="message-history" id="messageHistory">
                        <div style="text-align: center; color: #6b7280; font-style: italic;">
                            他のユーザーとの接続を待機中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Overlay -->
    <div class="image-overlay" id="imageOverlay" onclick="closeImageOverlay()">
        <img id="overlayImg">
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase設定ファイルをインポート
        import { getFirebaseConfig } from './firebase-config.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';

        // Firebase初期化
        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // Google認証プロバイダーの設定
        const provider = new GoogleAuthProvider();
        // COOPエラーを回避するための設定
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        // グローバルスコープに関数を公開
        window.firebaseAuth = {
            signIn: async () => {
                try {
                    // リダイレクト方式を試用（ポップアップの代替）
                    const result = await signInWithPopup(auth, provider);
                    return result;
                } catch (error) {
                    console.warn('ポップアップログインに失敗、リダイレクト方式を試行:', error);
                    // リダイレクト方式にフォールバック
                    const { signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js');
                    return signInWithRedirect(auth, provider);
                }
            },
            signOut: () => signOut(auth),
            onAuthStateChanged: (callback) => onAuthStateChanged(auth, callback)
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    
    <script>
        // Firebase認証とグローバル関数の初期化
        let currentUser = null;
        let peer = null;
        let connections = new Map();
        let selectedFile = null;
        let onlineUsers = new Set();
        
        const statusEl = document.getElementById('status');
        const sendBtn = document.getElementById('sendBtn');
        const fileBtn = document.getElementById('fileBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const messageInput = document.getElementById('messageInput');
        const messageHistory = document.getElementById('messageHistory');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const previewImg = document.getElementById('previewImg');
        const fileIcon = document.getElementById('fileIcon');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileType = document.getElementById('fileType');
        const imageOverlay = document.getElementById('imageOverlay');
        const overlayImg = document.getElementById('overlayImg');
        const loginSection = document.getElementById('loginSection');
        const mainContent = document.getElementById('mainContent');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');

        // グローバル関数として定義（HTMLから呼び出し可能）
        window.handleSignIn = async function() {
            try {
                const result = await window.firebaseAuth.signIn();
                console.log('ログイン成功:', result.user);
            } catch (error) {
                console.error('ログインエラー:', error);
                alert('ログインに失敗しました: ' + error.message);
            }
        };

        window.handleSignOut = async function() {
            try {
                await window.firebaseAuth.signOut();
                console.log('ログアウト成功');
            } catch (error) {
                console.error('ログアウトエラー:', error);
                alert('ログアウトに失敗しました: ' + error.message);
            }
        };

        // Firebase認証の初期化とグローバル関数の定義
        window.addEventListener('DOMContentLoaded', async () => {
            // Firebase認証が準備されるまで少し待機
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 認証状態の監視
            if (window.firebaseAuth) {
                window.firebaseAuth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = {
                            id: user.uid,
                            name: user.displayName,
                            email: user.email,
                            picture: user.photoURL
                        };
                        
                        // UIを更新
                        loginSection.style.display = 'none';
                        mainContent.style.display = 'block';
                        userInfo.style.display = 'flex';
                        userName.textContent = currentUser.name;
                        userAvatar.src = currentUser.picture;
                        
                        // P2P接続を開始
                        initializeP2P();
                    } else {
                        // ログアウト状態
                        currentUser = null;
                        loginSection.style.display = 'flex';
                        mainContent.style.display = 'none';
                        userInfo.style.display = 'none';
                        
                        // 接続をクリーンアップ
                        if (peer) {
                            peer.destroy();
                            peer = null;
                        }
                        connections.clear();
                        onlineUsers.clear();
                        clearMessageHistory();
                    }
                });
            }
        });

        function initializeP2P() {
            updateStatus('P2P接続を初期化中...', 'connecting');
            
            const peerOptions = {
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            };
            
            // Googleアカウントのユニークな部分を使用してPeer IDを生成
            const peerId = 'user-' + currentUser.id.substring(0, 12);
            peer = new Peer(peerId, peerOptions);
            
            peer.on('open', (id) => {
                console.log('My peer ID is: ' + id);
                updateStatus('他のユーザーを検索中...', 'connecting');
                
                // 他のユーザーへの自動接続を試行
                discoverAndConnectUsers();
                
                messageInput.disabled = false;
                fileBtn.disabled = false;
                pasteBtn.disabled = false;
            });
            
            peer.on('connection', (conn) => {
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                updateStatus('エラーが発生しました: ' + err.message, 'disconnected');
            });
        }

        function discoverAndConnectUsers() {
            // 実際のアプリケーションでは、ここでサーバーから他のオンラインユーザーのリストを取得し、
            // 自動的に接続を試行します。この例では、デモ用の仮想ユーザーIDを使用します。
            
            // デモ用: 複数の仮想ユーザーIDに接続を試行
            const demoUserIds = ['user-demo1', 'user-demo2', 'user-demo3'];
            
            demoUserIds.forEach(userId => {
                if (userId !== peer.id) {
                    setTimeout(() => {
                        tryConnectToUser(userId);
                    }, Math.random() * 2000);
                }
            });
            
            // 接続が確立されなかった場合のタイムアウト
            setTimeout(() => {
                if (connections.size === 0) {
                    updateStatus('他のユーザーが見つかりません - 待機中', 'connecting');
                    addSystemMessage('他のユーザーの接続を待っています...');
                }
            }, 5000);
        }

        function tryConnectToUser(userId) {
            try {
                const conn = peer.connect(userId);
                setupConnection(conn);
            } catch (err) {
                console.log('Failed to connect to user:', userId);
            }
        }

        function setupConnection(conn) {
            conn.on('open', () => {
                connections.set(conn.peer, conn);
                onlineUsers.add(conn.peer);
                
                updateConnectionStatus();
                
                // 初回接続時にユーザー情報を交換
                conn.send({
                    type: 'user_info',
                    user: currentUser,
                    timestamp: new Date().toISOString()
                });
                
                addSystemMessage(`${conn.peer} と接続しました`);
            });
            
            conn.on('data', (data) => {
                console.log('Received:', data);
                handleReceivedData(data, conn.peer);
            });
            
            conn.on('close', () => {
                connections.delete(conn.peer);
                onlineUsers.delete(conn.peer);
                updateConnectionStatus();
                addSystemMessage(`${conn.peer} との接続が切断されました`);
            });
            
            conn.on('error', (err) => {
                console.error('Connection error:', err);
                connections.delete(conn.peer);
                onlineUsers.delete(conn.peer);
                updateConnectionStatus();
            });
        }

        function updateConnectionStatus() {
            const connectedCount = connections.size;
            if (connectedCount > 0) {
                updateStatus(`${connectedCount}人のユーザーと接続済み`, 'connected');
                sendBtn.disabled = false;
            } else {
                updateStatus('他のユーザーを検索中...', 'connecting');
                sendBtn.disabled = true;
            }
        }

        function handleReceivedData(data, fromPeer) {
            const timestamp = new Date().toLocaleTimeString();
            
            if (data.type === 'user_info') {
                // ユーザー情報を受信
                console.log('User info received from:', fromPeer, data.user);
                return;
            }
            
            if (data.type === 'text') {
                addMessage(data.message, 'received', data.timestamp || timestamp, fromPeer);
            } else if (data.type === 'image') {
                addImageMessage(data.fileData, data.filename, data.filesize, 'received', data.timestamp || timestamp, data.message, fromPeer);
            } else if (data.type === 'file') {
                addFileMessage(data.fileData, data.filename, data.filesize, data.filetype, 'received', data.timestamp || timestamp, data.message, fromPeer);
            }
        }

        function broadcastToAllConnections(data) {
            connections.forEach((conn, peerId) => {
                if (conn.open) {
                    conn.send(data);
                }
            });
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            const timestamp = new Date().toLocaleTimeString();
            
            if (connections.size === 0) return;
            
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = e.target.result;
                    const isImage = selectedFile.type.startsWith('image/');
                    
                    const data = {
                        type: isImage ? 'image' : 'file',
                        fileData: fileData,
                        filename: selectedFile.name,
                        filesize: formatFileSize(selectedFile.size),
                        filetype: selectedFile.type,
                        timestamp: timestamp
                    };
                    
                    if (message) {
                        data.message = message;
                    }
                    
                    broadcastToAllConnections(data);
                    
                    if (isImage) {
                        addImageMessage(fileData, selectedFile.name, formatFileSize(selectedFile.size), 'sent', timestamp, message);
                    } else {
                        addFileMessage(fileData, selectedFile.name, formatFileSize(selectedFile.size), selectedFile.type, 'sent', timestamp, message);
                    }
                    
                    clearPreview();
                    messageInput.value = '';
                };
                reader.readAsDataURL(selectedFile);
            }
            else if (message) {
                const data = {
                    type: 'text',
                    message: message,
                    timestamp: timestamp
                };
                
                broadcastToAllConnections(data);
                addMessage(message, 'sent', timestamp);
                messageInput.value = '';
            }
        }

        function updateStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addMessage(message, type, timestamp, fromPeer = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const messageText = document.createElement('div');
            messageText.textContent = message;
            
            // コピーボタンを追加
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'コピー';
            copyBtn.style.cssText = 'font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-top: 0.5rem; background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); border-radius: 0.25rem; cursor: pointer; color: inherit;';
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(message).then(() => {
                    copyBtn.textContent = 'コピー済み!';
                    setTimeout(() => copyBtn.textContent = 'コピー', 1500);
                }).catch(() => {
                    copyBtn.textContent = '失敗';
                    setTimeout(() => copyBtn.textContent = 'コピー', 1500);
                });
            };
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = fromPeer ? `${timestamp} - ${fromPeer}` : timestamp;
            
            messageEl.appendChild(messageText);
            messageEl.appendChild(copyBtn);
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addImageMessage(imageData, filename, filesize, type, timestamp, message = '', fromPeer = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type} image-message`;
            
            const imgEl = document.createElement('img');
            imgEl.src = imageData;
            imgEl.onclick = () => showImageOverlay(imageData);
            imgEl.style.maxWidth = '100%';
            imgEl.style.borderRadius = '0.5rem';
            imgEl.style.cursor = 'pointer';
            
            const fileInfoEl = document.createElement('div');
            fileInfoEl.className = 'file-info';
            fileInfoEl.textContent = `${filename} (${filesize})`;
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = fromPeer ? `${timestamp} - ${fromPeer}` : timestamp;
            
            messageEl.appendChild(imgEl);
            messageEl.appendChild(fileInfoEl);
            
            if (message) {
                const messageText = document.createElement('div');
                messageText.textContent = message;
                messageText.style.marginTop = '0.5rem';
                messageEl.appendChild(messageText);
            }

            const saveBtn = document.createElement('button');
            saveBtn.textContent = '保存';
            saveBtn.style.cssText = 'margin-top: 0.5rem; padding: 0.375rem 0.75rem; font-size: 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer;';
            saveBtn.onclick = () => downloadFile(imageData, filename);
            messageEl.appendChild(saveBtn);
            
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addFileMessage(fileData, filename, filesize, filetype, type, timestamp, message = '', fromPeer = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type} file-message`;
            
            const fileInfoEl = document.createElement('div');
            fileInfoEl.className = 'file-info-display';
            
            const fileIconEl = document.createElement('div');
            fileIconEl.className = 'file-icon';
            fileIconEl.style.fontSize = '0.75rem';
            fileIconEl.style.fontWeight = 'bold';
            fileIconEl.style.textAlign = 'center';
            fileIconEl.style.marginBottom = '0.75rem';
            fileIconEl.textContent = getFileIcon(filetype);
            
            const fileNameEl = document.createElement('div');
            fileNameEl.style.fontWeight = '600';
            fileNameEl.style.marginBottom = '0.375rem';
            fileNameEl.textContent = filename;
            
            const fileDetailsEl = document.createElement('div');
            fileDetailsEl.className = 'file-info';
            fileDetailsEl.innerHTML = `${getFileTypeName(filetype)} • ${filesize}`;
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'file-download';
            downloadBtn.textContent = 'ダウンロード';
            downloadBtn.onclick = () => downloadFile(fileData, filename);
            
            fileInfoEl.appendChild(fileIconEl);
            fileInfoEl.appendChild(fileNameEl);
            fileInfoEl.appendChild(fileDetailsEl);
            fileInfoEl.appendChild(downloadBtn);
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = fromPeer ? `${timestamp} - ${fromPeer}` : timestamp;
            
            messageEl.appendChild(fileInfoEl);
            
            if (message) {
                const messageText = document.createElement('div');
                messageText.textContent = message;
                messageText.style.marginTop = '0.75rem';
                messageText.style.padding = '0.75rem';
                messageText.style.background = 'rgba(255,255,255,0.5)';
                messageText.style.borderRadius = '0.5rem';
                messageEl.appendChild(messageText);
            }
            
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addSystemMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.style.textAlign = 'center';
            messageEl.style.color = '#6b7280';
            messageEl.style.fontStyle = 'italic';
            messageEl.style.margin = '0.75rem 0';
            messageEl.style.fontSize = '0.875rem';
            messageEl.textContent = message;
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function clearMessageHistory() {
            messageHistory.innerHTML = '<div style="text-align: center; color: #6b7280; font-style: italic;">他のユーザーとの接続を待機中...</div>';
        }
        
        function selectFile() {
            fileInput.click();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                showFilePreview(file);
            }
        }
        
        function showFilePreview(file) {
            const isImage = file.type.startsWith('image/');
            
            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                    fileIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.style.display = 'none';
                fileIcon.style.display = 'flex';
                fileIcon.textContent = getFileIcon(file.type);
            }
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileType.textContent = getFileTypeName(file.type);
            filePreview.style.display = 'block';
        }
        
        function clearPreview() {
            selectedFile = null;
            filePreview.style.display = 'none';
            fileInput.value = '';
        }
        
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'IMG';
            if (mimeType.startsWith('video/')) return 'VID';
            if (mimeType.startsWith('audio/')) return 'AUD';
            if (mimeType.includes('pdf')) return 'PDF';
            if (mimeType.includes('word')) return 'DOC';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'XLS';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'PPT';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('7z')) return 'ZIP';
            if (mimeType.includes('text')) return 'TXT';
            if (mimeType.includes('json') || mimeType.includes('xml')) return 'DATA';
            return 'FILE';
        }
        
        function getFileTypeName(mimeType) {
            const typeMap = {
                'application/pdf': 'PDFドキュメント',
                'application/msword': 'Wordドキュメント',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Wordドキュメント',
                'application/vnd.ms-excel': 'Excelスプレッドシート',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excelスプレッドシート',
                'application/vnd.ms-powerpoint': 'PowerPointプレゼンテーション',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'PowerPointプレゼンテーション',
                'application/zip': 'ZIPアーカイブ',
                'application/x-rar-compressed': 'RARアーカイブ',
                'text/plain': 'テキストファイル',
                'text/csv': 'CSVファイル',
                'application/json': 'JSONファイル',
                'text/xml': 'XMLファイル'
            };
            
            if (mimeType.startsWith('image/')) return '画像ファイル';
            if (mimeType.startsWith('video/')) return '動画ファイル';
            if (mimeType.startsWith('audio/')) return '音声ファイル';
            
            return typeMap[mimeType] || 'ファイル';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showImageOverlay(imageData) {
            overlayImg.src = imageData;
            imageOverlay.style.display = 'flex';
        }
        
        function closeImageOverlay() {
            imageOverlay.style.display = 'none';
        }
        
        function downloadFile(fileData, filename) {
            const link = document.createElement('a');
            link.href = fileData;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function pasteText() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    messageInput.value = text;
                    messageInput.focus();
                } else {
                    alert('クリップボードにテキストが見つかりません。');
                }
            } catch (err) {
                console.error('Clipboard access error:', err);
                alert('クリップボードにアクセスできませんでした。ブラウザの許可設定を確認してください。');
            }
        }
        
        // ドラッグ&ドロップ機能
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                selectedFile = file;
                showFilePreview(file);
            }
        });
        
        // Enterキーでメッセージ送信
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Ctrl+Vでテキスト貼り付け
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v' && connections.size > 0) {
                if (document.activeElement === messageInput) {
                    return;
                }
                e.preventDefault();
                pasteText();
            }
        });
        
        // ページ終了時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            connections.forEach(conn => conn.close());
            if (peer) {
                peer.destroy();
            }
        });
